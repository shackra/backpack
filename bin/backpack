#!/usr/bin/env sh

set -eu

ACTION="${1:-}"
FLAG="${2:-}"

if [ -z "$ACTION" ]; then
    echo "Error: missing argument" >&2
    echo "Usage: $0 <action> [flags]" >&2
    echo "" >&2
    echo "Available actions:" >&2
    echo "  ensure        Install and build all packages (without activation)" >&2
    echo "  gc [--dry-run] Remove orphaned packages no longer needed by configuration" >&2
    exit 1
fi

# Determine the Backpack installation directory based on this script's location
# This makes the script work regardless of where it's called from
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BACKPACK_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Verify this is actually a Backpack installation
if [ ! -f "$BACKPACK_DIR/ensure.el" ] || [ ! -d "$BACKPACK_DIR/base-packages" ]; then
    echo "Error: This script must be run from the Backpack installation directory" >&2
    echo "Expected to find ensure.el and base-packages/ in: $BACKPACK_DIR" >&2
    exit 1
fi

if [ "$ACTION" = "ensure" ]; then
    echo "Backpack: Synchronizing packages..."
    echo "Backpack directory: $BACKPACK_DIR"
    echo ""
    # Run Emacs in batch mode with ensure.el
    # ensure.el handles loading backpack.el with sync mode enabled
    emacs --batch \
        --eval "(setq user-emacs-directory \"$BACKPACK_DIR/\")" \
        -l "$BACKPACK_DIR/ensure.el"
    exit $?

elif [ "$ACTION" = "gc" ]; then
    DRY_RUN="nil"
    if [ "$FLAG" = "--dry-run" ] || [ "$FLAG" = "-n" ]; then
        DRY_RUN="t"
        echo "Backpack: Garbage collection (dry run)..."
    else
        echo "Backpack: Garbage collection..."
    fi
    echo "Backpack directory: $BACKPACK_DIR"
    echo ""
    # Run Emacs in batch mode with gc.el
    emacs --batch \
        --eval "(setq user-emacs-directory \"$BACKPACK_DIR/\")" \
        --eval "(setq backpack-gc-dry-run $DRY_RUN)" \
        -l "$BACKPACK_DIR/gc.el"
    exit $?

else
    echo "Error: unknown action '$ACTION'" >&2
    echo "Available actions: ensure, gc" >&2
    exit 1
fi
