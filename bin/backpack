#!/usr/bin/env sh

set -eu

ACTION="${1:-}"

if [ -z "$ACTION" ]; then
    echo "Error: missing argument" >&2
    echo "Usage: $0 <action>" >&2
    echo "" >&2
    echo "Available actions:" >&2
    echo "  ensure    Install and build all packages (without activation)" >&2
    exit 1
fi

# Find Emacs configuration directory
if [ -d "$HOME/.emacs.d" ]; then
    INIT_DIR="$HOME/.emacs.d"
elif [ -n "${XDG_CONFIG_HOME:-}" ] && [ -d "$XDG_CONFIG_HOME/emacs" ]; then
    INIT_DIR="$XDG_CONFIG_HOME/emacs"
else
    echo "Error: Emacs configuration directory not found" >&2
    echo "Expected: $HOME/.emacs.d or \$XDG_CONFIG_HOME/emacs" >&2
    exit 1
fi

if [ "$ACTION" = "ensure" ]; then
    echo "Backpack: Synchronizing packages..."
    echo "Configuration directory: $INIT_DIR"
    echo ""
    # Run Emacs in batch mode with ensure.el
    # ensure.el handles loading backpack.el with sync mode enabled
    emacs --batch \
        --eval "(setq user-emacs-directory \"$INIT_DIR/\")" \
        -l "$INIT_DIR/ensure.el"
    exit $?
else
    echo "Error: unknown action '$ACTION'" >&2
    echo "Available actions: ensure" >&2
    exit 1
fi
